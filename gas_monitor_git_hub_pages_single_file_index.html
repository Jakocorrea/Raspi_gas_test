<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Terminal de Calidad de Gas – Temperatura</title>
  <!-- Tailwind (Play CDN) for quick styling on GitHub Pages) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- ECharts for charts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root { color-scheme: dark light; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
    .card { @apply bg-white/60 dark:bg-slate-900/60 backdrop-blur rounded-2xl shadow-md border border-slate-200/30 dark:border-slate-700/50; }
    .badge { @apply inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-950 dark:to-slate-900 text-slate-800 dark:text-slate-100">
  <div class="max-w-7xl mx-auto p-4 md:p-8">
    <!-- Header -->
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold">Terminal de Calidad de Gas</h1>
        <p class="text-sm text-slate-500 dark:text-slate-400">Frontend estático listo para GitHub Pages • Fuente: Raspberry Pi → WebSocket</p>
      </div>
      <div class="flex flex-wrap items-center gap-2">
        <span id="conn-badge" class="badge bg-slate-200 dark:bg-slate-800 text-slate-700 dark:text-slate-200">Desconectado</span>
        <span id="latency-badge" class="badge bg-slate-200 dark:bg-slate-800 text-slate-700 dark:text-slate-200">Latencia: —</span>
        <button id="themeBtn" class="badge bg-slate-900 text-white dark:bg-white dark:text-slate-900">Tema</button>
      </div>
    </header>

    <!-- Controls -->
    <section class="card p-4 md:p-6 mb-6">
      <div class="grid md:grid-cols-3 gap-4 items-end">
        <label class="block">
          <span class="block text-xs uppercase tracking-wider text-slate-500">WebSocket URL (wss:// recomendado)</span>
          <input id="wsUrl" type="text" class="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white/80 dark:bg-slate-900/80 px-3 py-2" placeholder="wss://tu-dominio/ws" />
        </label>
        <label class="block">
          <span class="block text-xs uppercase tracking-wider text-slate-500">Ventana visible (min)</span>
          <input id="windowMin" type="number" min="1" max="240" value="30" class="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white/80 dark:bg-slate-900/80 px-3 py-2" />
        </label>
        <div class="flex gap-2">
          <button id="connectBtn" class="flex-1 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 font-medium">Conectar</button>
          <button id="pauseBtn" class="rounded-xl bg-slate-200 hover:bg-slate-300 dark:bg-slate-800 dark:hover:bg-slate-700 text-slate-900 dark:text-slate-100 px-4 py-2">Pausar</button>
          <button id="demoBtn" class="rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2">Demo</button>
        </div>
      </div>
      <p class="text-xs text-slate-500 mt-2">⚠️ Si publicas esto en GitHub Pages (HTTPS), tu WebSocket debe ser <strong>wss://</strong> con certificado válido. Los navegadores bloquean <strong>ws://</strong> desde sitios HTTPS.</p>
    </section>

    <!-- KPI Cards -->
    <section class="grid md:grid-cols-4 gap-4 mb-6">
      <div class="card p-4">
        <div class="text-xs text-slate-500">Temperatura actual</div>
        <div class="text-3xl font-bold"><span id="kpi-now">—</span><span class="text-base font-semibold text-slate-500"> °C</span></div>
        <div id="sparkline" class="h-12 mt-2"></div>
      </div>
      <div class="card p-4">
        <div class="text-xs text-slate-500">Mín / Máx (ventana)</div>
        <div class="text-xl font-semibold"><span id="kpi-min">—</span> / <span id="kpi-max">—</span> °C</div>
        <div class="text-xs text-slate-500 mt-2">Media: <span id="kpi-mean">—</span> · Desv: <span id="kpi-std">—</span></div>
      </div>
      <div class="card p-4">
        <div class="text-xs text-slate-500">Edad del dato</div>
        <div class="text-xl font-semibold"><span id="kpi-age">—</span></div>
        <div class="text-xs text-slate-500 mt-2">Pérdidas: <span id="kpi-lost">0</span></div>
      </div>
      <div class="card p-4">
        <div class="text-xs text-slate-500">Estado</div>
        <div id="alertBanner" class="text-sm">Sin alertas</div>
      </div>
    </section>

    <!-- Charts grid -->
    <section class="grid lg:grid-cols-3 gap-4">
      <div class="card p-2 lg:col-span-2"><div id="tsChart" class="h-72"></div></div>
      <div class="card p-2"><div id="gaugeChart" class="h-72"></div></div>
      <div class="card p-2"><div id="histChart" class="h-64"></div></div>
      <div class="card p-2"><div id="rollingChart" class="h-64"></div></div>
    </section>

    <!-- Footer -->
    <footer class="mt-8 text-center text-xs text-slate-500">
      <p>© <span id="yy"></span> Gas Monitor • UI estática para GitHub Pages. Requiere servidor WebSocket externo (wss://).</p>
    </footer>
  </div>

  <script>
    // --- Theme toggle ---
    const themeBtn = document.getElementById('themeBtn');
    const storedTheme = localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    document.documentElement.classList.toggle('dark', storedTheme === 'dark');
    themeBtn.addEventListener('click', () => {
      const isDark = document.documentElement.classList.toggle('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    });

    document.getElementById('yy').textContent = new Date().getFullYear();

    // --- Elements ---
    const wsUrlInput = document.getElementById('wsUrl');
    const windowMinInput = document.getElementById('windowMin');
    const connectBtn = document.getElementById('connectBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const demoBtn = document.getElementById('demoBtn');
    const connBadge = document.getElementById('conn-badge');
    const latencyBadge = document.getElementById('latency-badge');
    const kNow = document.getElementById('kpi-now');
    const kMin = document.getElementById('kpi-min');
    const kMax = document.getElementById('kpi-max');
    const kMean = document.getElementById('kpi-mean');
    const kStd = document.getElementById('kpi-std');
    const kAge = document.getElementById('kpi-age');
    const kLost = document.getElementById('kpi-lost');
    const alertBanner = document.getElementById('alertBanner');

    // Persist last ws URL
    wsUrlInput.value = localStorage.getItem('wsUrl') || '';

    // --- Chart init ---
    const tsChart = echarts.init(document.getElementById('tsChart'));
    const gaugeChart = echarts.init(document.getElementById('gaugeChart'));
    const histChart = echarts.init(document.getElementById('histChart'));
    const rollingChart = echarts.init(document.getElementById('rollingChart'));
    const sparkline = echarts.init(document.getElementById('sparkline'));

    // Temperature ranges for gauge
    const gaugeMin = 0, gaugeMax = 60; // ajusta si quieres
    const warnLow = 5, warnHigh = 35;  // umbrales de ejemplo

    tsChart.setOption({
      animation: false,
      grid: { left: 40, right: 20, top: 20, bottom: 40 },
      xAxis: { type: 'time' },
      yAxis: { type: 'value', name: '°C' },
      series: [{ type: 'line', showSymbol: false, data: [] }],
      tooltip: { trigger: 'axis' }
    });

    gaugeChart.setOption({
      series: [{
        type: 'gauge',
        min: gaugeMin,
        max: gaugeMax,
        axisLine: { lineStyle: { width: 14 } },
        splitLine: { length: 10 },
        pointer: { width: 4 },
        detail: { formatter: '{value} °C', fontSize: 18 },
        data: [{ value: 0 }]
      }]
    });

    histChart.setOption({
      animation: false,
      grid: { left: 40, right: 20, top: 20, bottom: 30 },
      xAxis: { type: 'category', data: [] },
      yAxis: { type: 'value' },
      series: [{ type: 'bar', data: [] }]
    });

    rollingChart.setOption({
      animation: false,
      grid: { left: 40, right: 20, top: 20, bottom: 30 },
      xAxis: { type: 'time' },
      yAxis: { type: 'value', name: 'Media móvil (°C)' },
      series: [{ type: 'line', showSymbol: false, data: [] }]
    });

    sparkline.setOption({
      animation: false,
      grid: { left: 0, right: 0, top: 5, bottom: 0 },
      xAxis: { type: 'time', show: false },
      yAxis: { type: 'value', show: false },
      series: [{ type: 'line', showSymbol: false, data: [] }]
    });

    // --- Data buffer ---
    let paused = false;
    let demoMode = false;
    let ws;
    let points = []; // {t, y}
    let lost = 0;

    function setConn(state) {
      if (state === 'ok') {
        connBadge.textContent = 'Conectado';
        connBadge.className = 'badge bg-emerald-100 text-emerald-800 dark:bg-emerald-900/50 dark:text-emerald-200';
      } else if (state === 'recon') {
        connBadge.textContent = 'Reconectando…';
        connBadge.className = 'badge bg-amber-100 text-amber-800 dark:bg-amber-900/50 dark:text-amber-200';
      } else {
        connBadge.textContent = 'Desconectado';
        connBadge.className = 'badge bg-slate-200 dark:bg-slate-800 text-slate-700 dark:text-slate-200';
      }
    }

    function updateKpis() {
      if (!points.length) return;
      const winMs = Number(windowMinInput.value) * 60 * 1000;
      const now = Date.now();
      points = points.filter(p => now - p.t <= winMs);
      const ys = points.map(p => p.y);
      const last = points[points.length - 1];
      const min = Math.min(...ys).toFixed(2);
      const max = Math.max(...ys).toFixed(2);
      const mean = (ys.reduce((a,b)=>a+b,0) / ys.length).toFixed(2);
      const std = Math.sqrt(ys.reduce((a,b)=>a + Math.pow(b-mean,2),0) / ys.length).toFixed(2);
      const age = ((now - last.t)/1000).toFixed(1) + ' s';
      
      kNow.textContent = last.y.toFixed(2);
      kMin.textContent = min;
      kMax.textContent = max;
      kMean.textContent = mean;
      kStd.textContent = std;
      kAge.textContent = age;
      kLost.textContent = lost;

      // Alerts demo (simple)
      if (last.y < warnLow || last.y > warnHigh) {
        alertBanner.innerHTML = `<span class="text-amber-600 dark:text-amber-300 font-medium">Alerta de umbral:</span> ${last.y.toFixed(2)} °C`;
      } else {
        alertBanner.textContent = 'Sin alertas';
      }

      // Charts
      tsChart.setOption({ series: [{ data: points.map(p => [p.t, p.y]) }] });
      gaugeChart.setOption({ series: [{ data: [{ value: last.y }] }] });
      sparkline.setOption({ series: [{ data: points.slice(-100).map(p => [p.t, p.y]) }] });

      // Rolling mean (60s)
      const windowSec = 60;
      const rm = [];
      let j = 0; // left pointer for sliding window
      for (let i=0; i<points.length; i++) {
        const ti = points[i].t;
        while (ti - points[j].t > windowSec*1000) j++;
        const slice = points.slice(j, i+1);
        const m = slice.reduce((a,b)=>a+b.y,0) / slice.length;
        rm.push([ti, m]);
      }
      rollingChart.setOption({ series: [{ data: rm }] });

      // Histogram (bins)
      const bins = 12;
      const minVal = Math.min(...ys), maxVal = Math.max(...ys);
      const step = (maxVal - minVal) || 1;
      const edges = Array.from({length: bins}, (_,i)=> minVal + (i*step)/bins);
      const counts = new Array(bins).fill(0);
      ys.forEach(v => {
        const idx = Math.min(bins-1, Math.max(0, Math.floor((v - minVal) / (step / bins))));
        counts[idx]++;
      });
      const labels = edges.map(v => (Math.round(v*10)/10).toString());
      histChart.setOption({ xAxis: { data: labels }, series: [{ data: counts }] });
    }

    function handleMessage(obj) {
      // obj = { ts, temperature_c, source }
      const t = obj.ts || Date.now();
      const y = Number(obj.temperature_c);
      if (Number.isFinite(y)) {
        points.push({ t, y });
        updateKpis();
      } else {
        lost++;
      }
    }

    function connectWS(url) {
      if (!url) return alert('Ingresa la URL del WebSocket');
      localStorage.setItem('wsUrl', url);
      if (ws && ws.readyState === WebSocket.OPEN) ws.close(1000);
      setConn('recon');
      ws = new WebSocket(url);
      const pingSent = { val: 0 };

      ws.addEventListener('open', () => {
        setConn('ok');
        latencyBadge.textContent = 'Latencia: —';
        // simple ping using ws send/echo (if server echos unknown frames) – otherwise rely on data latency
        pingSent.val = performance.now();
        try { ws.send(JSON.stringify({ type: 'ping', t: Date.now() })); } catch {}
      });

      ws.addEventListener('message', (ev) => {
        if (paused) return;
        try {
          const obj = JSON.parse(ev.data);
          if (obj && typeof obj === 'object') {
            if (obj.type === 'pong' && pingSent.val) {
              const rtt = (performance.now() - pingSent.val).toFixed(0);
              latencyBadge.textContent = `Latencia: ${rtt} ms`;
              pingSent.val = 0;
            }
            if ('temperature_c' in obj) handleMessage(obj);
          }
        } catch {
          // if not JSON, ignore
        }
      });

      ws.addEventListener('close', () => setConn('down'));
      ws.addEventListener('error', () => setConn('down'));
    }

    // Demo mode (sin servidor WS)
    let demoTimer;
    function toggleDemo() {
      demoMode = !demoMode;
      demoBtn.textContent = demoMode ? 'Demo ON' : 'Demo';
      demoBtn.classList.toggle('bg-indigo-700', demoMode);
      if (demoMode) {
        clearInterval(demoTimer);
        demoTimer = setInterval(() => {
          const last = points.at(-1)?.y ?? 25;
          const next = last + (Math.random()-0.5)*0.3 + Math.sin(Date.now()/30000)*0.02;
          handleMessage({ ts: Date.now(), temperature_c: next, source: 'demo' });
        }, 1000);
      } else {
        clearInterval(demoTimer);
      }
    }

    // UI events
    connectBtn.addEventListener('click', () => connectWS(wsUrlInput.value.trim()));
    pauseBtn.addEventListener('click', () => {
      paused = !paused;
      pauseBtn.textContent = paused ? 'Continuar' : 'Pausar';
    });
    demoBtn.addEventListener('click', toggleDemo);

    // Resize charts on window resize
    addEventListener('resize', () => { tsChart.resize(); gaugeChart.resize(); histChart.resize(); rollingChart.resize(); sparkline.resize(); });

    // Optional: auto-connect if stored URL exists
    if (wsUrlInput.value) connectWS(wsUrlInput.value);
  </script>
</body>
</html>

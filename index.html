<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Test WebSocket — Raspi Gas</title>
<style>
  :root{ --bg:#0b0b0e; --fg:#e5e7eb; --muted:#94a3b8; --ok:#10b981; --warn:#f59e0b; --err:#ef4444; --b:#1f2937 }
  html,body{ margin:0; height:100%; background:var(--bg); color:var(--fg); font-family:system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial }
  .wrap{ max-width:900px; margin:0 auto; padding:16px }
  .card{ background:#0f1115; border:1px solid var(--b); border-radius:12px; padding:12px; }
  .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:end }
  .col{ flex:1 1 260px }
  label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px }
  input{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--b); background:transparent; color:var(--fg) }
  button{ padding:10px 12px; border-radius:10px; border:1px solid var(--b); background:transparent; color:var(--fg); cursor:pointer }
  button:hover{ background:#141821 }
  .badge{ display:inline-flex; align-items:center; gap:6px; font-size:14px }
  .dot{ width:10px; height:10px; border-radius:999px; display:inline-block }
  .ok{ background:var(--ok) } .warn{ background:var(--warn) } .err{ background:var(--err) }
  .muted{ color:var(--muted); font-size:12px }
  pre{ margin:0; white-space:pre-wrap; word-break:break-word; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:12px; color:#cbd5e1 }
  .log{ height:280px; overflow:auto; padding-right:6px; background:#0b0d12; border:1px solid var(--b); border-radius:10px }
  .kv{ display:grid; grid-template-columns:140px 1fr; gap:8px; margin-top:8px }
  .kv div{ font-size:14px }
</style>
</head>
<body>
<div class="wrap">
  <h1 style="margin:0 0 10px 0; font-size:20px">Test WebSocket — Raspi Gas</h1>
  <div class="card" style="margin-bottom:12px">
    <div class="row">
      <div class="col">
        <label>WSS URL (requerido en GitHub Pages)</label>
        <input id="wsUrl" placeholder="wss://tu-endpoint (Cloudflare/ngrok/Caddy)" />
        <div id="httpsWarn" class="muted" style="margin-top:6px"></div>
      </div>
      <div>
        <button id="connectBtn">Conectar</button>
      </div>
      <div>
        <button id="disconnectBtn">Desconectar</button>
      </div>
      <div>
        <button id="sendPingBtn" title='Envía {"type":"ping","t":Date.now()}'>Ping</button>
      </div>
      <div>
        <button id="clearLogBtn" title="Limpia el log">Limpiar log</button>
      </div>
    </div>
    <div style="margin-top:10px; display:flex; gap:16px; align-items:center; flex-wrap:wrap">
      <div class="badge" id="status"><span class="dot err"></span><span>desconectado</span></div>
      <div class="muted">Latencia: <span id="lat">—</span></div>
      <div class="muted">Mensajes: <span id="count">0</span></div>
      <div class="muted">Último error: <span id="lastErr">—</span></div>
    </div>
  </div>

  <div class="card" style="margin-bottom:12px">
    <div style="font-weight:600; margin-bottom:6px">Último mensaje</div>
    <pre id="lastMsg">—</pre>
    <div class="kv">
      <div class="muted">ts:</div><div id="lastTs">—</div>
      <div class="muted">temperature_c:</div><div id="lastTemp">—</div>
      <div class="muted">source:</div><div id="lastSource">—</div>
    </div>
  </div>

  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px">
      <div style="font-weight:600">Log de mensajes (máx 200)</div>
      <label style="display:flex; align-items:center; gap:6px"><input type="checkbox" id="autoscroll" checked /> <span class="muted">Autoscroll</span></label>
    </div>
    <div class="log"><pre id="log"></pre></div>
  </div>

  <p class="muted" style="margin-top:10px">
    Consejos: Si cargas esta página en <b>HTTPS</b> (GitHub Pages), tu socket debe ser <b>WSS</b>. Usa el parámetro <code>?ws=wss://...</code> para autocompletar.
    Si tu servidor no implementa <code>pong</code>, el botón Ping solo enviará el mensaje y la latencia mostrada permanecerá en <i>—</i>.
  </p>
</div>

<script>
(function(){
  const el = (id) => document.getElementById(id)

  const wsUrl = el('wsUrl')
  const connectBtn = el('connectBtn')
  const disconnectBtn = el('disconnectBtn')
  const sendPingBtn = el('sendPingBtn')
  const clearLogBtn = el('clearLogBtn')
  const statusEl = el('status')
  const latEl = el('lat')
  const cntEl = el('count')
  const lastErrEl = el('lastErr')
  const lastMsgEl = el('lastMsg')
  const lastTsEl = el('lastTs')
  const lastTempEl = el('lastTemp')
  const lastSrcEl = el('lastSource')
  const logEl = el('log')
  const httpsWarn = el('httpsWarn')
  const autoscroll = el('autoscroll')

  let ws = null
  let msgCount = 0
  let backoff = 1000
  let pingOutstanding = null      // {t:number}
  let reconnectTimer = null

  // Inicial: toma ?ws= o localStorage
  const qs = new URLSearchParams(location.search)
  wsUrl.value = qs.get('ws') || localStorage.getItem('ws_test_url') || ''
  if (location.protocol === 'https:' && wsUrl.value.startsWith('ws://')) {
    httpsWarn.textContent = 'Estás en HTTPS → debes usar wss://'
  }

  function setStatus(kind, text){
    const color = kind === 'ok' ? 'ok' : kind === 'warn' ? 'warn' : 'err'
    statusEl.innerHTML = `<span class="dot ${color}"></span><span>${text}</span>`
  }

  function log(line){
    const stamp = new Date().toISOString()
    logEl.textContent += `[${stamp}] ${line}\n`
    if (autoscroll.checked) {
      logEl.parentElement.scrollTop = logEl.parentElement.scrollHeight
    }
  }

  function connect(){
    const url = wsUrl.value.trim()
    if (!url) { log('❌ URL vacía'); setStatus('err','desconectado'); return }
    if (location.protocol === 'https:' && url.startsWith('ws://')) {
      httpsWarn.textContent = 'HTTPS requiere WSS (wss://...)'
      log('❌ Bloqueado: ws:// en contexto HTTPS')
      setStatus('err','desconectado')
      return
    }
    // guarda
    localStorage.setItem('ws_test_url', url)

    try {
      setStatus('warn','conectando...')
      ws = new WebSocket(url)
      ws.onopen = () => {
        setStatus('ok','conectado')
        log('✅ Conexión abierta')
        backoff = 1000
      }
      ws.onmessage = (ev) => {
        let data = null
        try { data = JSON.parse(ev.data) } catch { data = ev.data }
        msgCount++
        cntEl.textContent = String(msgCount)
        lastMsgEl.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2)

        // Parse rápido del payload esperado
        if (data && typeof data === 'object') {
          lastTsEl.textContent = (typeof data.ts === 'number') ? new Date(data.ts).toLocaleString() : '—'
          lastTempEl.textContent = (typeof data.temperature_c === 'number') ? data.temperature_c.toFixed(2) + ' °C' : '—'
          lastSrcEl.textContent = data.source ?? '—'
        } else {
          lastTsEl.textContent = lastTempEl.textContent = lastSrcEl.textContent = '—'
        }

        // Latencia si el servidor responde "pong"
        if (data && typeof data === 'object' && data.type === 'pong') {
          // 1) si viene "latency"
          if (typeof data.latency === 'number') {
            latEl.textContent = data.latency + ' ms'
          }
          // 2) si retorna t original
          else if (pingOutstanding && typeof data.t === 'number') {
            const rtt = Date.now() - pingOutstanding.t
            latEl.textContent = rtt + ' ms'
            pingOutstanding = null
          }
        }

        log('⬅️ ' + (typeof data === 'string' ? data : JSON.stringify(data)))
      }
      ws.onerror = (e) => {
        lastErrEl.textContent = 'onerror'
        log('❌ onerror')
      }
      ws.onclose = () => {
        setStatus('warn','reconectando...')
        log('⚠️ Conexión cerrada')
        if (reconnectTimer) clearTimeout(reconnectTimer)
        reconnectTimer = setTimeout(() => {
          backoff = Math.min(backoff * 2, 30000)
          connect()
        }, backoff)
      }
    } catch (err) {
      lastErrEl.textContent = String(err)
      setStatus('err','desconectado')
      log('❌ Error creando WebSocket: ' + err)
    }
  }

  function disconnect(){
    if (reconnectTimer) { clearTimeout(reconnectTimer); reconnectTimer = null }
    if (ws) {
      try { ws.close() } catch {}
      ws = null
      setStatus('err','desconectado')
      log('🔌 Desconectado manualmente')
    }
  }

  function sendPing(){
    if (!ws || ws.readyState !== 1) { log('❌ No conectado'); return }
    const t = Date.now()
    pingOutstanding = { t }
    const msg = { type: 'ping', t }
    ws.send(JSON.stringify(msg))
    log('➡️ ' + JSON.stringify(msg))
  }

  connectBtn.addEventListener('click', connect)
  disconnectBtn.addEventListener('click', disconnect)
  sendPingBtn.addEventListener('click', sendPing)
  clearLogBtn.addEventListener('click', () => { logEl.textContent = '' })

  // Autoconectar si vino ?ws=
  if (qs.get('ws')) {
    connect()
  }
})();
</script>
</body>
</html>
